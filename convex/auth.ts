import Resend from "@auth/core/providers/resend";
import { convexAuth } from "@convex-dev/auth/server";

export const { auth, signIn, signOut, store, isAuthenticated } = convexAuth({
  providers: [
    Resend({
      from: "signin@haricot.app",
      // OTP mode - user receives a code and enters it in the app
      async generateVerificationToken() {
        // Generate a 6-digit numeric code
        return Math.floor(100000 + Math.random() * 900000).toString();
      },
      async sendVerificationRequest({ identifier: email, provider, token }) {
        const { Resend: ResendAPI } = await import("resend");
        const resend = new ResendAPI(process.env.AUTH_RESEND_KEY);

        // Clean the email address of any whitespace or special characters
        const cleanEmail = email.trim();

        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(cleanEmail)) {
          throw new Error(`Invalid email address: ${cleanEmail}`);
        }

        await resend.emails.send({
          from: 'Haricot <signin@haricot.app>',
          to: cleanEmail,
          subject: "Your Haricot sign-in code",
          html: `
          <div style="max-width: 600px; margin: 0 auto; padding: 40px; background-color: #f0f0f0; color: black; border-radius: 20px; font-family: sans-serif">
         <svg xmlns="http://www.w3.org/2000/svg" id="Layer_2" data-name="Layer 2" viewBox="0 0 252.55 49.94"><defs><style>.cls-1{fill:#010101}</style></defs><g id="Layer_1-2" data-name="Layer 1"><path d="M32.13 49.94c-1.22 0-1.96-.73-1.96-1.95V28.06c0-.25 0-.66-1.17-.66H8.21c-.76 0-1.59.13-1.61.48v20.1c0 1.22-.73 1.95-1.96 1.95H1.96C.74 49.93 0 49.2 0 47.97V3.19c0-1.23.73-1.96 1.96-1.96h2.69c1.22 0 1.96.73 1.96 1.96v18.76c0 .5.09.95 1.17.95h21.59c.62 0 .81-.19.81-.81V3.19c0-1.23.73-1.96 1.96-1.96h2.69c1.22 0 1.96.73 1.96 1.96v44.79c0 1.22-.73 1.96-1.96 1.96h-2.69Z" class="cls-1"/><path d="M5.88 21.95c0 1.12.63 1.67 1.89 1.67h21.59q1.53 0 1.53-1.53V3.19c0-.82.41-1.24 1.24-1.24h2.69c.82 0 1.24.41 1.24 1.24v44.79c0 .82-.41 1.24-1.24 1.24h-2.69c-.82 0-1.24-.41-1.24-1.23V28.06q0-1.38-1.89-1.38H8.21c-1.5 0-2.28.39-2.33 1.16v20.15c0 .82-.41 1.23-1.24 1.23H1.96c-.82 0-1.24-.41-1.24-1.24V3.19c0-.82.41-1.24 1.24-1.24h2.69c.82 0 1.24.41 1.24 1.24v18.76ZM74.32 49.86c-.79-.05-1.82-.39-2.38-1.78l-4.69-11.84c-.14-.33-.47-.78-1.74-.78H50.27c-1.3 0-1.69.6-1.88 1.11l-5.01 12.17c-.28.56-.84 1.18-2.11 1.18h-1.16c-.58 0-1-.18-1.25-.54-.26-.37-.29-.85-.08-1.44L57.42 1.25C57.89.21 58.52 0 58.96 0c.5 0 1.18.26 1.62 1.5l18.31 46.22c.18.44.38 1.09.12 1.61l-.05.1-.08.08c-.29.29-.73.43-1.38.43l-3.19-.07Zm-9.74-19.1c.25 0 .39-.02.48-.05 0-.03-6.68-16.86-6.68-16.86-.17-.41-.31-.62-.39-.71-.09.11-.24.35-.42.86-2.23 5.62-4.47 11.17-6.67 16.52-.04.1-.07.18-.08.24z" class="cls-1"/><path d="m47.73 36.33-5 12.15c-.24.49-.72.73-1.44.73h-1.16c-.68 0-.89-.34-.65-1.02L58.09 1.52c.24-.53.53-.8.87-.8.39 0 .7.34.94 1.02l18.32 46.24c.19.49.24.82.15 1.02-.14.15-.43.22-.86.22l-3.17-.07c-.82-.05-1.39-.49-1.73-1.33l-4.69-11.84c-.34-.82-1.14-1.23-2.41-1.23H50.27q-1.965 0-2.55 1.59Zm9.16-22.58c-2.24 5.67-4.46 11.16-6.65 16.49-.34.82-.12 1.24.66 1.24h13.69c1.07 0 1.43-.39 1.09-1.17l-6.63-16.72q-.51-1.23-1.08-1.23c-.57 0-.74.47-1.08 1.4ZM110.58 49.94c-1.05 0-1.83-.31-2.31-.93L92.11 26.3c-.33-.46-.5-.89-.5-1.29 0-.3.12-1.28 1.67-1.28q.33 0 .75.06c.21.03.73.07 1.99.07 1.05 0 2.45-.02 4.22-.07 2.7-.05 4.86-.9 6.6-2.63 1.74-1.72 2.58-3.76 2.58-6.25 0-3.06-.97-5.42-2.96-7.21-1.99-1.78-4.47-2.69-7.37-2.69h-8.43c-.81 0-.81.26-.81.52v42.46c0 1.22-.73 1.96-1.96 1.96H85.2c-1.22 0-1.96-.73-1.96-1.96V3.19c0-1.23.73-1.96 1.96-1.96h13.89c4.77 0 8.79 1.02 11.95 3.02 3.7 2.36 5.57 5.77 5.57 10.13 0 3.94-1.48 7.2-4.39 9.71-2.7 2.29-5.91 3.45-9.56 3.45-.56 0-.89.04-1.08.08.06.11.14.26.29.46l13.78 19.46.03.05c.09.2.14.4.14.6 0 1.07-.69 1.74-1.81 1.74h-3.42Z" class="cls-1"/><path d="M100.77 27.4c0 .24.17.61.51 1.09l13.74 19.41c.05.1.07.19.07.29 0 .68-.36 1.02-1.09 1.02h-3.42c-.82 0-1.41-.22-1.75-.65L92.69 25.87q-.36-.51-.36-.87c0-.48.53-.65 1.6-.51q1.02.15 6.33 0c2.86-.05 5.22-.99 7.09-2.84 1.87-1.84 2.8-4.1 2.8-6.76 0-3.25-1.07-5.83-3.2-7.74s-4.75-2.87-7.85-2.87h-8.43c-1.02 0-1.53.41-1.53 1.24v42.46c0 .82-.41 1.24-1.24 1.24h-2.69c-.82 0-1.24-.41-1.24-1.24V3.19c0-.82.41-1.24 1.24-1.24H99.1c4.65 0 8.51.97 11.56 2.91 3.49 2.23 5.24 5.41 5.24 9.53 0 3.73-1.38 6.79-4.14 9.16q-3.855 3.27-9.09 3.27c-1.26 0-1.89.19-1.89.58ZM123.9 1.24h2.69c1.08 0 1.96.88 1.96 1.96v44.79c0 1.08-.88 1.96-1.96 1.96h-2.69c-1.08 0-1.96-.88-1.96-1.96V3.19c0-1.08.88-1.96 1.96-1.96Z" class="cls-1"/><path d="M122.66 3.19c0-.82.41-1.24 1.24-1.24h2.69c.82 0 1.24.41 1.24 1.24v44.79c0 .82-.41 1.24-1.24 1.24h-2.69c-.82 0-1.24-.41-1.24-1.24zM156.17 49.94c-6.48 0-12.07-2.42-16.62-7.2-4.55-4.77-6.85-10.63-6.85-17.44s2.3-12.62 6.85-17.41c4.56-4.8 10.15-7.23 16.63-7.23 8.18 0 14.15 2.91 17.77 8.64 1.13 1.81.22 2.66-.22 2.94-.39.21-.75.4-1.12.59-.47.24-.87.36-1.24.36-.43 0-1.19-.18-1.5-1.38-.35-1.65-1.74-3.25-4.12-4.78-2.78-1.79-5.9-2.7-9.28-2.7-4.75 0-8.52 1.92-11.53 5.86-3.01 3.95-4.54 8.98-4.54 14.93s1.54 11.28 4.57 15.13c3.03 3.86 6.77 5.73 11.43 5.73 3.61 0 6.83-.94 9.55-2.8 1.61-1.1 2.83-2.32 3.65-3.62.19-.42.4-.91.59-1.41.49-1.02 1.1-1.51 1.84-1.51.29 0 .6.11.99.35.31.19.79.58 1.52 1.23.44.33 1.06 1.2-.11 2.84-3.94 5.89-10.09 8.88-18.25 8.88Z" class="cls-1"/><path d="M172.64 37.61c.27.16.74.55 1.42 1.15.48.37.41 1-.22 1.88q-5.745 8.58-17.67 8.58c-6.3 0-11.67-2.32-16.1-6.97-4.44-4.65-6.65-10.3-6.65-16.95s2.22-12.24 6.65-16.91c4.44-4.67 9.8-7.01 16.1-7.01 7.95 0 13.67 2.77 17.16 8.3q.87 1.395 0 1.95c-.34.19-.69.37-1.05.56s-.67.28-.91.28c-.39 0-.65-.28-.8-.84-.39-1.83-1.87-3.56-4.44-5.2-2.91-1.87-6.13-2.81-9.67-2.81-4.94 0-8.98 2.05-12.11 6.15s-4.69 9.22-4.69 15.37 1.57 11.57 4.73 15.58c3.15 4.01 7.15 6.01 12 6.01 3.78 0 7.1-.98 9.96-2.93 1.7-1.16 2.98-2.44 3.85-3.84.24-.51.46-1.02.65-1.53.34-.7.73-1.05 1.16-1.05.15 0 .35.08.62.24ZM198.49 49.94c-6.53 0-12.17-2.43-16.77-7.23-4.59-4.79-6.92-10.65-6.92-17.41s2.33-12.62 6.92-17.41c4.6-4.8 10.25-7.23 16.77-7.23s12.15 2.43 16.73 7.23c4.57 4.79 6.89 10.65 6.89 17.41s-2.32 12.62-6.89 17.41c-4.58 4.8-10.21 7.23-16.73 7.23m.21-45.89c-4.46 0-8.16 2-11.32 6.1-3.16 4.11-4.76 9.16-4.76 15.01 0 6.22 1.54 11.37 4.58 15.29 3.03 3.92 6.79 5.82 11.5 5.82s8.39-1.94 11.42-5.92c3.04-3.99 4.58-9.1 4.58-15.19s-1.6-10.9-4.76-15.01c-3.16-4.1-6.84-6.1-11.25-6.1Z" class="cls-1"/><path d="M175.51 25.3c0-6.6 2.24-12.24 6.73-16.91 4.48-4.67 9.9-7.01 16.25-7.01s11.75 2.34 16.21 7.01 6.69 10.31 6.69 16.91-2.23 12.24-6.69 16.91-9.86 7.01-16.21 7.01-11.77-2.34-16.25-7.01-6.73-10.31-6.73-16.91m6.4-.14c0 6.42 1.57 11.66 4.73 15.73 3.15 4.07 7.17 6.1 12.07 6.1s8.85-2.07 12-6.21 4.73-9.35 4.73-15.62-1.64-11.19-4.91-15.45c-3.27-4.25-7.21-6.38-11.82-6.38s-8.62 2.13-11.89 6.38-4.91 9.4-4.91 15.45" class="cls-1"/><path d="M232.88 49.94c-1.22 0-1.96-.73-1.96-1.96V5.67h-12.76c-2.08 0-2.39-1-2.39-1.59V2.84c0-1.06.95-1.59 2.83-1.59h31.19c2.28 0 2.76.87 2.76 1.59v1.24c0 .59-.3 1.59-2.32 1.59h-11.09c-.87 0-1.18.02-1.28.04h-.02l-.1.03c-.16.03-.21.04-.21.31V48c0 1.22-.73 1.96-1.96 1.96h-2.69Z" class="cls-1"/><path d="M231.65 6.03c0-.58-.04-.91-.11-.98s-.4-.11-.98-.11h-12.4c-1.12 0-1.67-.29-1.67-.87V2.83c0-.58.7-.87 2.11-.87h31.19q2.04 0 2.04.87v1.24c0 .58-.53.87-1.6.87h-11.09c-.92 0-1.43.03-1.53.07-.53.1-.8.44-.8 1.02v41.95c0 .82-.41 1.24-1.24 1.24h-2.69c-.82 0-1.24-.41-1.24-1.24V6.03Z" class="cls-1"/></g></svg>
            
         <h1>Your sign-in code is: <strong style="color:#e314c4; font-weight: bold;">${token}</strong></h1>
          <p>This code will expire in 10 minutes.</p>
          <p>If you did not request this code, <i>please ignore this email.</i></p>
          <p>-Haricot</p>

          <hr>
      
          <footer>
          HARICOT APP SYNDICATE
          123 EASY STREET, TOWN, COUNTRY
          <p>Copyright ${new Date().getFullYear()} Haricot App Syndicate. All rights reserved.</p>
          <p>This email was sent to ${cleanEmail}</p>
          <p>If you have any questions, please contact us at <a href="mailto:support@haricot.app">support@haricot.app</a></p>
          </footer>
          </div>
          `,
        });
      },
    }),
  ],
});